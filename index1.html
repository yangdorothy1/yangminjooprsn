<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Audio Reactive Lava Lamp</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: #000; /* 전체 배경 */
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    /* 핵심: 라바 램프 효과를 만드는 필터 */
    #canvas-container {
      /* 블러로 경계를 흐리고, 콘트라스트로 다시 선명하게 만들어 겹친 부분을 합침 */
      filter: blur(20px) contrast(50);
      background-color: #000;
    }

    /* 안내 문구 스타일 */
    #overlay {
      position: absolute;
      color: white;
      font-family: sans-serif;
      text-align: center;
      pointer-events: none; /* 클릭 통과 */
      z-index: 10;
      mix-blend-mode: difference;
    }
  </style>
</head>
<body>

  <div id="overlay">
    <h1>Lava Lamp Visualizer</h1>
    <p>화면을 클릭하여 마이크를 켜세요</p>
  </div>
  
  <div id="canvas-container"></div>

  <script>
    let mic;
    let particles = [];
    let isStarted = false;

    // 파티클(도트) 클래스 정의
    class Particle {
      constructor() {
        this.x = random(width);
        this.y = random(height);
        this.r = random(40, 80); // 기본 반지름
        this.xSpeed = random(-1, 1);
        this.ySpeed = random(-1, 1);
        // 각 파티클마다 고유한 움직임 오프셋을 줌
        this.offset = random(100); 
      }

      update(level) {
        // 1. 기본 움직임 (둥둥 떠다니는 효과)
        this.x += this.xSpeed;
        this.y += this.ySpeed;

        // 2. 화면 경계 튕기기
        if (this.x < 0 || this.x > width) this.xSpeed *= -1;
        if (this.y < 0 || this.y > height) this.ySpeed *= -1;

        // 3. 오디오 반응: 소리가 크면 반지름(r)이 커짐
        // level은 0.0 ~ 1.0 사이의 값
        let audioBoost = map(level, 0, 1, 0, 100); 
        this.currentR = this.r + audioBoost;
      }

      display() {
        noStroke();
        // 라바 램프 색상 (여기서는 네온 그린/옐로우 계열)
        // CSS Contrast 필터 때문에 색상이 강렬하게 변형됨
        fill(100, 255, 100); 
        ellipse(this.x, this.y, this.currentR * 2);
      }
    }

    function setup() {
      // 캔버스를 컨테이너 안에 생성
      let canvas = createCanvas(windowWidth, windowHeight);
      canvas.parent('canvas-container');

      // 마이크 입력 생성 (브라우저 정책상 클릭 후 start 필요)
      mic = new p5.AudioIn();
      
      // 파티클 20개 생성
      for (let i = 0; i < 20; i++) {
        particles.push(new Particle());
      }
    }

    function draw() {
      background(0); // 배경을 검정으로 칠해 잔상을 없앰

      let vol = 0;
      if (isStarted) {
        // 마이크 볼륨 가져오기 (0.0 ~ 1.0)
        vol = mic.getLevel(); 
        // 반응성을 높이기 위해 부드럽게 보간 (Lerp) 가능하지만 여기선 직관적으로 처리
      }

      // 모든 파티클 업데이트 및 그리기
      for (let p of particles) {
        p.update(vol);
        p.display();
      }
    }

    // 화면 클릭 시 오디오 컨텍스트 시작
    function mousePressed() {
      if (!isStarted) {
        userStartAudio(); // 브라우저 오디오 정책 준수
        mic.start();
        isStarted = true;
        document.getElementById('overlay').style.display = 'none';
      }
    }

    // 창 크기 조절 시 캔버스 크기 대응
    function windowResized() {
      resizeCanvas(windowWidth, windowHeight);
    }
  </script>
</body>
</html>
